<!DOCTYPE html>
<html>
  
  <head>
    
    <meta charset="utf-8">
    <title>Social Media Viz Demo</title>

    <!-- load D3 library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

  </head>
  
  <body>
    
   
    
    <script>
      
window.addEventListener("load",run);
      
/*
 * Demo: social media 2013-2014 data
 * 
 * Version charting two years
 * Using D3 for DOM manipulation
 *
 */
function run () {
	var site_list = ["linkedin", "twitter","instagram", "facebook", "pinterest"];  
	//probably a better way to do this by getting specific elements of data (ie. data.site)
	var category_list = ["gender", "race", "age", "education", "salary", "location"];
	//employment is not included in these charts because it is only available for 1/5  sites
	var num_svg = site_list.length * category_list.length;
	var counter = 0;
	make_svgs(num_svg);
	//circle('facebook', 'age', "viz");
	for (var s = 0; s < site_list.length; s++)
		{
			for (var c = 0; c < category_list.length; c++)
			{
				//bar(site_list[s],category_list[c], "svg" + counter);
				stackedbars(category_list[c], "svg" + counter);
				counter += 1;
			}
		}		 
}
/* From 
   http://www.pewinternet.org/files/2015/01/PI_SocialMediaUpdate20144.pdf
*/
//schema : site, category, group, value
function getDataRows (site,category) 
{
    var data = [
	{ site:"linkedin", category:"gender", group:"men", value:26},
	{ site:"linkedin", category:"gender", group:"women", value:25},
	{ site:"linkedin", category:"race", group:"White, Non-Hispanic", value:26},	
	{ site:"linkedin", category:"race", group:"Black, Non-Hispanic", value:22},
	{ site:"linkedin", category:"race", group:"Hispanic", value:22},	
	{ site:"linkedin", category:"age", group:"18-29", value:22},		
	{ site:"linkedin", category:"age", group:"30-49", value:32},		
	{ site:"linkedin", category:"age", group:"50-64", value:26},		
	{ site:"linkedin", category:"age", group:"65+", value:12},		
	{ site:"linkedin", category:"education", group:"High school grad or less", value:9},		
	{ site:"linkedin", category:"education", group:"Some college", value:25},		
	{ site:"linkedin", category:"education", group:"College+", value:46},
	{ site:"linkedin", category:"salary", group:"Less than $30,000", value:17},				
	{ site:"linkedin", category:"salary", group:"$30,000-$49,999", value:21},				
	{ site:"linkedin", category:"salary", group:"$50,000-$74,999", value:32},
	{ site:"linkedin", category:"salary", group:"$75,000+", value:41},				
	{ site:"linkedin", category:"employment", group:"Employed", value:32},				
	{ site:"linkedin", category:"employment", group:"Not employed", value:41},				
	{ site:"linkedin", category:"location", group:"Urban", value:30},				
	{ site:"linkedin", category:"location", group:"Suburban", value:26},				
	{ site:"linkedin", category:"location", group:"Rural", value:12},				
	
	{ site:"twitter", category:"gender", group:"men", value:25},
	{ site:"twitter", category:"gender", group:"women", value:21},
	{ site:"twitter", category:"race", group:"White, Non-Hispanic", value:20},	
	{ site:"twitter", category:"race", group:"Black, Non-Hispanic", value:28},
	{ site:"twitter", category:"race", group:"Hispanic", value:28},	
	{ site:"twitter", category:"age", group:"18-29", value:32},		
	{ site:"twitter", category:"age", group:"30-49", value:29},		
	{ site:"twitter", category:"age", group:"50-64", value:13},		
	{ site:"twitter", category:"age", group:"65+", value:6},		
	{ site:"twitter", category:"education", group:"High school grad or less", value:19},		
	{ site:"twitter", category:"education", group:"Some college", value:23},		
	{ site:"twitter", category:"education", group:"College+", value:27},
	{ site:"twitter", category:"salary", group:"Less than $30,000", value:21},				
	{ site:"twitter", category:"salary", group:"$30,000-$49,999", value:19},				
	{ site:"twitter", category:"salary", group:"$50,000-$74,999", value:25},
	{ site:"twitter", category:"salary", group:"$75,000+", value:26},				
	// { site:"twitter", category:"employment", group:"Employed", value:0},				
	// { site:"twitter", category:"employment", group:"Not employed", value:0},				
	{ site:"twitter", category:"location", group:"Urban", value:30},				
	{ site:"twitter", category:"location", group:"Suburban", value:21},				
	{ site:"twitter", category:"location", group:"Rural", value:15},				
				
	{ site:"facebook", category:"gender", group:"men", value:66},
	{ site:"facebook", category:"gender", group:"women", value:77},
	{ site:"facebook", category:"race", group:"White, Non-Hispanic", value:70},	
	{ site:"facebook", category:"race", group:"Black, Non-Hispanic", value:67},
	{ site:"facebook", category:"race", group:"Hispanic", value:75},	
	{ site:"facebook", category:"age", group:"18-29", value:82},		
	{ site:"facebook", category:"age", group:"30-49", value:79},		
	{ site:"facebook", category:"age", group:"50-64", value:64},		
	{ site:"facebook", category:"age", group:"65+", value:48},		
	{ site:"facebook", category:"education", group:"High school grad or less", value:71},		
	{ site:"facebook", category:"education", group:"Some college", value:72},		
	{ site:"facebook", category:"education", group:"College+", value:72},
	{ site:"facebook", category:"salary", group:"Less than $30,000", value:73},				
	{ site:"facebook", category:"salary", group:"$30,000-$49,999", value:72},				
	{ site:"facebook", category:"salary", group:"$50,000-$74,999", value:66},
	{ site:"facebook", category:"salary", group:"$75,000+", value:78},			
	{ site:"facebook", category:"location", group:"Urban", value:74},				
	{ site:"facebook", category:"location", group:"Suburban", value:72},				
	{ site:"facebook", category:"location", group:"Rural", value:67},	

	{ site:"pinterest", category:"gender", group:"men", value:16},
	{ site:"pinterest", category:"gender", group:"women", value:44},
	{ site:"pinterest", category:"race", group:"White, Non-Hispanic", value:32},	
	{ site:"pinterest", category:"race", group:"Black, Non-Hispanic", value:23},
	{ site:"pinterest", category:"race", group:"Hispanic", value:32},	
	{ site:"pinterest", category:"age", group:"18-29", value:37},		
	{ site:"pinterest", category:"age", group:"30-49", value:36},		
	{ site:"pinterest", category:"age", group:"50-64", value:24},		
	{ site:"pinterest", category:"age", group:"65+", value:16},		
	{ site:"pinterest", category:"education", group:"High school grad or less", value:25},		
	{ site:"pinterest", category:"education", group:"Some college", value:37},		
	{ site:"pinterest", category:"education", group:"College+", value:31},
	{ site:"pinterest", category:"salary", group:"Less than $30,000", value:24},				
	{ site:"pinterest", category:"salary", group:"$30,000-$49,999", value:37},				
	{ site:"pinterest", category:"salary", group:"$50,000-$74,999", value:41},
	{ site:"pinterest", category:"salary", group:"$75,000+", value:30},			
	{ site:"pinterest", category:"location", group:"Urban", value:26},				
	{ site:"pinterest", category:"location", group:"Suburban", value:34},				
	{ site:"pinterest", category:"location", group:"Rural", value:31},	

	{ site:"instagram", category:"gender", group:"men", value:24},
	{ site:"instagram", category:"gender", group:"women", value:31},
	{ site:"instagram", category:"race", group:"White, Non-Hispanic", value:21},
	{ site:"instagram", category:"race", group:"Black, Non-Hispanic", value:47},
	{ site:"instagram", category:"race", group:"Hispanic", value:38},	
	{ site:"instagram", category:"age", group:"18-29", value:55},		
	{ site:"instagram", category:"age", group:"30-49", value:28},		
	{ site:"instagram", category:"age", group:"50-64", value:11},		
	{ site:"instagram", category:"age", group:"65+", value:4},		
	{ site:"instagram", category:"education", group:"High school grad or less", value:25},		
	{ site:"instagram", category:"education", group:"Some college", value:32},	
	{ site:"instagram", category:"education", group:"College+", value:26},
	{ site:"instagram", category:"salary", group:"Less than $30,000", value:26},
	{ site:"instagram", category:"salary", group:"$30,000-$49,999", value:27},	
	{ site:"instagram", category:"salary", group:"$50,000-$74,999", value:30},
	{ site:"instagram", category:"salary", group:"$75,000+", value:26},			
	{ site:"instagram", category:"location", group:"Urban", value:32},			
	{ site:"instagram", category:"location", group:"Suburban", value:28},		
	{ site:"instagram", category:"location", group:"Rural", value:18}	
    ];
    
    return data.filter(function(row) {
	return (row.site===site && row.category === category) ; });
}  

function bar(site,category,svg_id)
{
 	var data = getDataRows(site, category);
    var svg = d3.select("#"+svg_id);

    // get the size of the SVG element
    var height = svg.attr("height");
    var width = svg.attr("width");

    var margin = 20;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var padding = 5; 
    var barWidth= chartWidth/data.length - padding;

    var color_list =["#407F7F", "#226666", "#0D4D4D", "#003333"];
    svg.selectAll('rect')
    	.data(data)
    	.enter()
    	.append('rect')
    	.attr('x', function(d, i){return margin+i*chartWidth/data.length;})
    	.attr('y', function(d){return chartHeight+ margin- d.value * .01 * (chartHeight - 1.5 * margin) - 35;})
    	.attr('width', barWidth)
    	.attr('height', function(d){return (d.value * .01 * (chartHeight - 1.5 * margin));})
    	.attr('fill', function(d,i) {return color_list[i];});
    
	svg.selectAll('text')
		.data(data)
		.enter()
		.append("text")
		.text(function(d){return d.value + "%";})
		.attr("x",function(d, i){return margin + barWidth / 2 + i * chartWidth / data.length;})
 		.attr("y", chartHeight + margin - 38)
 		//.attr("y",function(d){return chartHeight + margin - d.value * .01 * (chartHeight - 1.5 *margin) + d.value * .2 * .01 * (chartHeight - 1.5 * margin);})
		//.attr("dy","0.3em")
		.style("text-anchor","middle")
		.style("font-family","sans-serif")
		.style("font-weight","bold")
		.style("font-size","12px")
		.style("fill", "white")
		.append("tspan")
		.text(function(d){return d.group.toUpperCase()})
		.attr("x",function(d, i){return margin+barWidth/2+i*chartWidth/data.length;})
		.attr("y", function(d){return chartHeight;})
		.style("fill", "#669999");

	svg.append("text")
		.text(site.toUpperCase())
		.attr("x", width/2)
		.attr("y", margin)
		.style("text-anchor","middle")
		.style("font-family","sans-serif")
		.style("font-weight","bold")
		.style("font-size","15px")
		.style("fill", "#669999");



}

function stackedbars(category, svg_id)
{
	var svg = d3.select("#"+svg_id);
	var last_y_height = 0;
	var site_list = ["linkedin", "pinterest", "facebook", "instagram", "twitter"];
	var color_list =["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56"];
	var height = svg.attr("height");
    var width = svg.attr("width");
    var margin = 20;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var padding = 5; 
    var barWidth= chartWidth/site_list.length - padding;

	for (var i = 0; i < site_list.length; i++)
		{
	 	var data = getDataRows(site_list[i], category);
		svg.selectAll('rect')
	    	.data(data)
	    	.enter()
	    	.append('rect')
	    	.attr('x', function() {return barWidth*i+padding*i+margin;}) 
	    	.attr('y', function(d){return chartHeight+ margin- d.value * .01 * (chartHeight - 1.5 * margin) - 35 - last_y_height;})
	    	.attr('width', barWidth)
	    	.attr('height', function(d){last_y_height = last_y_height + (d.value * .01 * (chartHeight - 1.5 * margin)); console.log(last_y_height); return (d.value * .01 * (chartHeight - 1.5 * margin));})
	    	.attr('fill', function(d,i) {return color_list[i];});
		}



}

function circle(site,category,svg_id)
{
    var data = getDataRows(site, category);
    var svg = d3.select("#"+svg_id);

    // get the size of the SVG element
    var height = svg.attr("height");
    var width = svg.attr("width");

    // the chart lives in the svg surrounded by a margin of 100px
    var margin = 50;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    // figure out the width of the bars so that all bars fit and 
    //   there is one bar width between them
    // note that every data point now has _2_ bars associated with 
    //   it
    //var maxArea = Math.PI*Math.pow(chartWidth/(2*data2013.length), 2);
    var sorted_data= data.sort()
    var est_radius = chartWidth/(2.5*sorted_data.length-1);
    var color = "lightblue";

    // first draw all the 2014 circles, then 2013
	sorted_data.forEach(function(v,i) {
	    //var radius = Math.sqrt(v.value*.01*maxArea/Math.PI);
	    var radius = 10*Math.sqrt(v.value/Math.PI);
	    // figure out where the vetical bar starts
	    var yPos = height/2 - margin;
        svg.append("circle")
		.attr("cx",margin+(i*2.5)*est_radius+ radius)
		.attr("cy",yPos)
		.attr("r", Math.round(radius))
		.style("stroke","white")
		.style("stroke-width","2px")
		.style("fill",color);

		// create bar & value text
	    // add some styles to make it pretty too
	    svg.append("text")
		.attr("x",margin+(i*2.5)*est_radius + radius)
 		.attr("y",yPos)
		.attr("dy","0.3em")
		.style("text-anchor","middle")
		.style("font-family","sans-serif")
		.style("font-weight","bold")
		.style("font-size","12px")
		.style("fill","black")
		.append("tspan")
		.attr("x",margin+(i*2.5)*est_radius + radius)
		.text(v.value)
		.append("tspan")
		.attr("x",margin+(i*2.5)*est_radius + radius)
		.attr("dy", 10)
		.text("("+v.group+")");

		svg.append("text")
		.text(site)
		.attr("x", width/2)
		.attr("y", margin)
		.style("text-anchor","middle")
		.style("font-family","sans-serif")
		.style("font-weight","bold")
		.style("font-size","12px")
		.style("fill", "green");
    });
}
    
    function make_svgs(num_svg)
    {
    	var height = 350;
    	var width = 500;
    	var margin = 10;
    	for (var i = 0; i < num_svg; i++)
    	{
    		var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    		svg.setAttribute("width", width);
    		svg.setAttribute("height", height);
    		svg.setAttribute("x", i%3 * (width + margin));
    		svg.setAttribute("y", Math.floor(i/3) * (height + margin));
    		svg.setAttribute('style', 'border: 1px solid gray');
    		svg.setAttribute("id", "svg"+i);
    		document.body.appendChild(svg);
    	}

    }



    </script>
    
  </body>
  
</html>